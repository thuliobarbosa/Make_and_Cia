class CadastroUsuario {

	constructor(formularioCadastro, tabelaDeUsuarios) {
		
		this.formularioCad = document.getElementById(formularioCadastro);
        this.tabelaUsuario = document.getElementById(tabelaDeUsuarios);

		this.listaUsuarios();
		this.formCadUsuario();
		this.atualizaContador();

	}

	// Realiza o cadastro de um usuario ao bd
	formCadUsuario() { 
	
		let btnCadUsuario = document.querySelector("#btnCadastroUser");
	
		this.formularioCad.addEventListener('submit', (event) => {
			event.preventDefault();
		});
		
		
		btnCadUsuario.addEventListener('click', () => {
			
			let isAdm = this.formularioCad.querySelector("#admin").checked;
			
			requestAjax("InserirUsuario", this.formularioCad).then(
				
				(retorno) => {
					
		        	alert(retorno);
					this.formularioCad.reset();
					this.atualizaContador();
					
					requestAjax("ListarUsuario", this.formularioCad).then(
						
						(retorno) => {
				
							this.addLine(retorno[retorno.length - 1]);
							
	   					},
		 
						(error) => {
							console.log(error);
						}	
					);
	        	},
	
				(error) => {
					console.log(error);
				}
			);
		});
	
	}

	// Lista usuários já cadastrado
	listaUsuarios() {
		
		requestAjax("ListarUsuario", this.formularioCad).then(
			
			(retorno) => {
			
				retorno.forEach((campo) => {
				
					let tr = document.createElement('tr');
				
					tr.innerHTML += `
						<td>${campo.nome}</td>
						<td>${campo.email}</td>
						<td>${(campo.admin) ? 'Sim' : 'Não'}</td>
			            <td>
			            <button type="button" class="btn btn-primary btn-edit btn-xs btn-flat" onclick="editaCadastro(${campo.id})">Editar</button>
			            <button type="button" class="btn btn-danger btn-xs btn-flat" onclick="excluiCadastro(${campo.id})">Excluir</button>
			            </td> 
						
		        	`;

					tr.querySelector(".btn-edit").addEventListener('click', () => {
						this.mostraFormularioEdit();
					});
							
					this.tabelaUsuario.appendChild(tr);
				
				});
		
		
		   	}, 
		
			(error) => {
				console.log(error)
			}
			
		);
	
	};

	// Adiciona uma nova linha com o novo usuario cadastrado
	addLine(dados) {
		
		let tr = document.createElement("tr");
		
		tr.innerHTML = `
					<td>${dados.nome}</td>
					<td>${dados.email}</td>
					<td>${(dados.admin) ? 'Sim' : 'Não'}</td>
		            <td>
		            <button type="button" class="btn btn-primary btn-edit btn-xs btn-flat" onclick="editaCadastro(${dados.id})">Editar</button>
	            	<button type="button" class="btn btn-danger btn-xs btn-flat" onclick="excluiCadastro(${dados.id})">Excluir</button>
		            </td> 
		`;
		
		tr.querySelector(".btn-edit").addEventListener('click', () => {
			this.mostraFormularioEdit();
		});
		
		this.tabelaUsuario.appendChild(tr);
		
	};
	
	// Consulta a quantidade de registro no bd para atualizar o info de usuários
	atualizaContador() {

		requestAjax("ListarUsuario", this.formularioCad).then(
			
			(retorno) => {
			
				document.querySelector("#quantidade-usuarios").innerHTML = retorno.length;
				document.querySelector("#quantidade-usuarios-admin").innerHTML = retorno.length;
		
		   	}, 
		
			(error) => {
				console.log(error)
			}
			
		);

    };

	mostraFormularioCad() {
        document.querySelector("#box-cadastro-usuario").style.display = "block";
        document.querySelector("#box-edit-usuario").style.display = "none";
    }

    mostraFormularioEdit() {
        document.querySelector("#box-cadastro-usuario").style.display = "none";
        document.querySelector("#box-edit-usuario").style.display = "block";
    }	
}

// Adiciona os dados no formulario de edição e altera os valores
function editaCadastro(idUsuario) {
	
	let formEdit = document.querySelector("#form-edit-usuario");
	
	let id = formEdit.querySelector("#idUserEdit");

	id.value = idUsuario;
	
	formEdit.querySelector("#btnEditUsuarioCancelar").addEventListener('click', () => {
		document.querySelector("#box-cadastro-usuario").style.display = "block";
        document.querySelector("#box-edit-usuario").style.display = "none";
	});
	
	requestAjax("ConsultarUsuario", formEdit).then(
			
		(retorno) => {
			
			formEdit.querySelector("#EdNome").value = retorno.nome
			formEdit.querySelector("#EdPassword").value = retorno.password
			formEdit.querySelector("#EdEmail").value = retorno.email
			formEdit.querySelector("#EdAdmin").value = retorno.admin
			
			let btn = formEdit.querySelector("#btnEditUsuario");
			
			btn.addEventListener('click', (event) => {
				
				let modal = document.querySelector("#modalConfirm");
				modal.style.display = "block";
				modal.querySelector("#pModal").innerHTML = "Deseja alterar o usuário?";
				
				let opSim = modal.querySelector("#btnModalSim");
				opSim.addEventListener('click', () => {
					
					requestAjax("AlterarUsuario", formEdit).then(
			
					(retorno) => {
						formEdit.reset();
			   		}, 
			
					(error) => {
						console.log(error)
					}
			
				);
					
					modal.style.display = "none"
				});
				
				let opNao = modal.querySelector("#btnModalNao");
				opNao.addEventListener('click', () => {
					modal.style.display = "none"
				});
		
			});
	   	}, 
	
		(error) => {
			console.log(error)
		}
			
	);

}

function excluiCadastro(idUsuario) {
	
	var formCad = document.querySelector("#form-cadastro-usuario");
	
	let id = formCad.querySelector("#idUserCad");

	id.value = idUsuario;
	
	let modal = document.querySelector("#modalConfirm");
	modal.style.display = "block";
	modal.querySelector("#pModal").innerHTML = "Deseja excluir o usuário?";
	
	let opSim = modal.querySelector("#btnModalSim");
	opSim.addEventListener('click', () => {
		
		requestAjax("ExcluiUsuario", formCad).then(
			
		(retorno) => {
		
			alert(retorno);
			console.log(retorno);
	
	   	}, 
	
		(error) => {
			console.log(error)
		}
			
	);
		
		modal.style.display = "none"
		
	});
	
	let opNao = modal.querySelector("#btnModalNao");
	opNao.addEventListener('click', () => {
		modal.style.display = "none"
	});
	
}


